name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'py_agent'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: linux
            executable_name: py_agent
            artifact_name: py_agent-linux
          - os: windows-latest
            target: windows
            executable_name: py_agent.exe
            artifact_name: py_agent-windows
          - os: macos-latest
            target: macos
            executable_name: py_agent
            artifact_name: py_agent-macos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create build info
      shell: bash
      run: |
        mkdir -p build_info
        echo "Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > build_info/build_info.txt
        echo "Git Commit: ${{ github.sha }}" >> build_info/build_info.txt
        echo "Git Branch: ${{ github.ref_name }}" >> build_info/build_info.txt
        echo "Build Number: ${{ github.run_number }}" >> build_info/build_info.txt
        echo "Python Version: ${{ env.PYTHON_VERSION }}" >> build_info/build_info.txt
        echo "Target Platform: ${{ matrix.target }}" >> build_info/build_info.txt

    - name: Build executable with PyInstaller
      shell: bash
      run: |
        pyinstaller --onefile \
          --name ${{ matrix.executable_name }} \
          --add-data "config:config" \
          --add-data "build_info:build_info" \
          --hidden-import openai \
          --hidden-import prompt_toolkit \
          --hidden-import chardet \
          --hidden-import json_repair \
          --collect-all prompt_toolkit \
          --collect-all chardet \
          main.py

    - name: Create distribution package
      shell: bash
      run: |
        mkdir -p dist_package/${{ matrix.target }}
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/${{ matrix.executable_name }} dist_package/${{ matrix.target }}/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp -r config dist_package/${{ matrix.target }}/
        
        # å¤åˆ¶æž„å»ºä¿¡æ¯
        cp -r build_info dist_package/${{ matrix.target }}/
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p dist_package/${{ matrix.target }}/logs
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        if [ "${{ matrix.target }}" = "windows" ]; then
          echo "@echo off" > dist_package/${{ matrix.target }}/start.bat
          echo "echo Starting PyAgent..." >> dist_package/${{ matrix.target }}/start.bat
          echo "${{ matrix.executable_name }}" >> dist_package/${{ matrix.target }}/start.bat
          echo "pause" >> dist_package/${{ matrix.target }}/start.bat
        else
          echo "#!/bin/bash" > dist_package/${{ matrix.target }}/start.sh
          echo "echo Starting PyAgent..." >> dist_package/${{ matrix.target }}/start.sh
          echo "chmod +x ${{ matrix.executable_name }}" >> dist_package/${{ matrix.target }}/start.sh
          echo "./${{ matrix.executable_name }}" >> dist_package/${{ matrix.target }}/start.sh
          chmod +x dist_package/${{ matrix.target }}/start.sh
        fi
        
        # åˆ›å»ºREADME
        cat > dist_package/${{ matrix.target }}/README.txt << EOF
        PyAgent - AI Assistant Command Line Tool
        ======================================
        
        æ–‡ä»¶ç»“æž„ï¼š
        â”œâ”€â”€ ${{ matrix.executable_name }}    # ä¸»å¯æ‰§è¡Œæ–‡ä»¶
        â”œâ”€â”€ config/                        # é…ç½®æ–‡ä»¶ç›®å½•
        â”‚   â”œâ”€â”€ provider_config.json      # APIæä¾›å•†é…ç½®
        â”‚   â”œâ”€â”€ system_prompt.txt         # ç³»ç»Ÿæç¤ºè¯
        â”‚   â”œâ”€â”€ conversation_memory.json  # å¯¹è¯è®°å¿†
        â”‚   â””â”€â”€ word_count.json           # è¯æ•°ç»Ÿè®¡
        â”œâ”€â”€ logs/                         # æ—¥å¿—æ–‡ä»¶ç›®å½•
        â”œâ”€â”€ build_info/                   # æž„å»ºä¿¡æ¯
        â””â”€â”€ start.${{ matrix.target == 'windows' && 'bat' || 'sh' }}    # å¯åŠ¨è„šæœ¬
        
        ä½¿ç”¨æ–¹æ³•ï¼š
        1. é…ç½®APIå¯†é’¥ï¼šç¼–è¾‘ config/provider_config.json
        2. è¿è¡Œç¨‹åºï¼šæ‰§è¡Œ start.${{ matrix.target == 'windows' && 'bat' || 'sh' }}
        3. æˆ–ç›´æŽ¥è¿è¡Œï¼š./${{ matrix.executable_name }}
        
        çŽ¯å¢ƒå˜é‡ï¼š
        - ARK_API_KEY: è±†åŒ…APIå¯†é’¥
        - DEEPSEEK_API_KEY: DeepSeek APIå¯†é’¥
        - DASHSCOPE_API_KEY: é˜¿é‡Œäº‘APIå¯†é’¥
        - HUNYUAN_API_KEY: è…¾è®¯APIå¯†é’¥
        - MOONSHOT_API_KEY: Moonshot APIå¯†é’¥
        
        ç‰ˆæœ¬ä¿¡æ¯ï¼š
        æž„å»ºæ—¶é—´ï¼š$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Gitæäº¤ï¼š${{ github.sha }}
        æž„å»ºå·ï¼š${{ github.run_number }}
        EOF

    - name: Create archive
      shell: bash
      run: |
        cd dist_package
        if [ "${{ matrix.target }}" = "windows" ]; then
          7z a -tzip ../${{ matrix.artifact_name }}.zip ${{ matrix.target }}/
        else
          tar -czf ../${{ matrix.artifact_name }}.tar.gz ${{ matrix.target }}/
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.*
          dist_package/${{ matrix.target }}/
        retention-days: 90

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "artifacts/*/*"
        generateReleaseNotes: true
        makeLatest: true
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## PyAgent - AI Assistant Command Line Tool
          
          è‡ªåŠ¨æž„å»ºçš„è·¨å¹³å°ç‰ˆæœ¬ï¼ŒåŒ…å«å¯æ‰§è¡Œæ–‡ä»¶å’Œå®Œæ•´é…ç½®ã€‚
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          - **py_agent-windows.zip**: Windows 64ä½ç‰ˆæœ¬
          - **py_agent-linux.tar.gz**: Linux 64ä½ç‰ˆæœ¬  
          - **py_agent-macos.tar.gz**: macOS 64ä½ç‰ˆæœ¬
          
          - Git Commit: ${{ github.sha }}
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}
          
          ---
