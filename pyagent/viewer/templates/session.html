<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è¯è®°å½• - {{ current_session }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='session.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>å¯¹è¯è®°å½•</h1>
            </div>
            
            <div class="session-list">
                {% for session in sessions %}
                <div class="session-item-container" style="position: relative;">
                    <a href="/session/{{ session.session_id }}" class="session-item {% if session.session_id == current_session %}active{% endif %}">
                        <div class="session-title">{{ session.title }}</div>
                        <div class="session-info">
                            <div>æ¶ˆæ¯: {{ session.message_count }}</div>
                            <div>{{ session.first_message_time[:19] }}</div>
                        </div>
                    </a>
                    <button class="session-delete" onclick="showDeleteModal('{{ session.session_id }}', event)">
                        åˆ é™¤
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="main-content">
            {% if not db_exists %}
            <div class="db-not-exist">
                <h2>æ•°æ®åº“ä¸å­˜åœ¨</h2>
                <p>æ— æ³•æ‰¾åˆ°å¯¹è¯è®°å½•æ•°æ®åº“æ–‡ä»¶</p>
                <button class="import-button" onclick="document.getElementById('dbFile').click()">
                    å¯¼å…¥æ•°æ®åº“
                </button>
                <input type="file" id="dbFile" class="file-input" accept=".db" onchange="importDatabase()">
                
                <div class="loading" id="loading">
                    æ­£åœ¨å¯¼å…¥æ•°æ®åº“...
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                
                <div class="success-message" id="successMessage"></div>
            </div>
            {% else %}
            <div class="main-header">
                <h2>ä¼šè¯: {{ current_session }}</h2>
            </div>
            
            {% if conversations %}
            <div class="conversation-list">
                {% for msg in conversations %}
                <div class="message">
                    <div class="message-header">
                        <span class="message-role {{ msg.role }}">{{ msg.role.upper() }}</span>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span class="message-session-id">{{ current_session }}</span>
                            <span class="message-time">{{ msg.timestamp }}</span>
                        </div>
                    </div>
                    
                    {% if msg.thinking %}
                    <div class="thinking">
                        <div class="thinking-label">æ€è€ƒè¿‡ç¨‹:</div>
                        <div>{{ msg.thinking }}</div>
                    </div>
                    {% endif %}
                    
                    {% if msg.role != 'tool' %}
                    <div class="message-content">
                        {% if msg.content is string %}
                            <div class="content-text">{{ msg.content }}</div>
                        {% elif msg.content is iterable and msg.content is not mapping %}
                            <div class="content-list">
                                {% for item in msg.content %}
                                    <div class="content-item">
                                        {% if item.type %}
                                            <div class="content-type">ç±»å‹: {{ item.type }}</div>
                                        {% endif %}
                                        {% if item.text %}
                                            <div>{{ item.text }}</div>
                                        {% endif %}
                                        {% if item.type == 'image_url' and item.image_url %}
                                            <div class="content-image">
                                                {% if item.image_url.url %}
                                                    {% if 'base64' in item.image_url.url %}
                                                        <img src="{{ item.image_url.url }}" alt="Base64å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                                    {% else %}
                                                        <img src="{{ item.image_url.url }}" alt="å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                                    {% endif %}
                                                {% elif item.image_url is string %}
                                                    {% if 'base64' in item.image_url %}
                                                        <img src="{{ item.image_url }}" alt="Base64å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                                    {% else %}
                                                        <img src="{{ item.image_url }}" alt="å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="content-text">{{ msg.content }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if msg.role == 'assistant' and msg.tool_calls %}
                    <div class="tool-calls">
                        {% for tool_call in msg.tool_calls %}
                        <div class="assistant-tool-call">
                            <div class="assistant-tool-header" onclick="toggleAssistantTool(this)">
                                <span class="assistant-tool-name">âš™ï¸ {{ tool_call.function.name }}</span>
                                <span class="assistant-tool-toggle">å±•å¼€å‚æ•° â–¼</span>
                            </div>
                            <div class="assistant-tool-args">
                                <div class="tool-args">{{ tool_call.function.arguments }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if msg.role == 'tool' %}
                    <div class="tool-result-section">
                        <div class="tool-result-collapsible" onclick="toggleToolResult(this)">
                            <span>ğŸ”§ å·¥å…·æ‰§è¡Œç»“æœ</span>
                            <span class="collapsible-icon">â–¶</span>
                        </div>
                        <div class="tool-result-content">
                            {% if msg.content is string %}
                                {{ msg.content }}
                            {% elif msg.content is iterable %}
                                {% for item in msg.content %}
                                    {% if item.text %}
                                        {{ item.text }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {{ msg.content }}
                            {% endif %}

                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <h2>æš‚æ— å¯¹è¯è®°å½•</h2>
                <p>è¯¥ä¼šè¯ä¸­è¿˜æ²¡æœ‰ä»»ä½•æ¶ˆæ¯</p>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš ï¸ ç¡®è®¤åˆ é™¤</h3>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹ä¼šè¯å—ï¼Ÿ</p>
                <p id="sessionToDelete" style="font-weight: bold; color: var(--text-primary); margin: 12px 0; font-family: monospace; background: #f5f5f5; padding: 8px; border-radius: 4px;"></p>
                <p style="color: #ef4444;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†æ°¸ä¹…åˆ é™¤ä¼šè¯ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideDeleteModal()">å–æ¶ˆ</button>
                <button id="confirmDelete" class="btn btn-danger" onclick="deleteSession()">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='session.js') }}"></script>
</body>
</html>